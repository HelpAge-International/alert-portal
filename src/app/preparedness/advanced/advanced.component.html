<div *ngIf="!isViewing">
  <app-country-admin-header></app-country-admin-header>
  <app-country-admin-menu></app-country-admin-menu>
</div>

<app-status-alert [message]="alertMessage?.message" [success]="alertMessage?.type === alertMessageType.Success"
                  [show]="alertMessage"></app-status-alert>


<!-- EXPORT DOCUMENTS MODAL -->
<div class="modal fade" id="export_documents" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">{{"DOCUMENTS.EXPORT" | translate}}</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="text-center"><p>{{"YOU_ARE_ABOUT_TO_EXPORT" | translate}} <strong>{{documents.length}} {{"DOCUMENT_S" | translate}}</strong> {{"AGENCY_ADMIN.SETTINGS.DOCUMENTS.WITH_SIZE" | translate}} <strong>{{docsSize | number:'1.0-2'}}MB</strong> {{"ARE_YOU_SURE_YOU_WISH_TO_CONTINUE" | translate}}</p></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="closeExportModal()">{{"GLOBAL.CANCEL" | translate}}</button>
        <button type="button" class="btn btn-primary" (click)="exportAllDocsFromModal(documentActionId)">{{"CONFIRM" | translate}}</button>
      </div>
    </div>
  </div>
</div>


<!-- PAGE -->
<div class="Page-top__wrap--w_sub_header--no-paddng">
  <div class="Full-page__wrap--inner">

    <div *ngIf="!isViewing">
      <ng-template [ngIf]="countrySelected && !agencySelected">
        <app-agency-submenu [countryId]="countryId"></app-agency-submenu>
        <app-alert-widget [countryId]="countryId"></app-alert-widget>
      </ng-template>
      <ng-template [ngIf]="agencySelected">
        <app-country-submenu [agencyId]="agencyId" [countryId]="countryId"></app-country-submenu>
        <app-alert-widget [countryId]="countryId"></app-alert-widget>
      </ng-template>
    </div>

    <div class="Header-title__wrap">
      <h1>{{"ADVANCED_PREP_ACTIONS" | translate}}</h1>
      <!--tooltip-->
      <tooltip
        [level1]="'TOOLTIPS.PREPAREDNESS.TT7.LEVEL1'">
      </tooltip>
      <div *ngIf="!isViewing && (permissionsAreEnabled.customAPA.New || userType == userTypes.CountryAdmin)"
           class="btn-group">
        <button type="button" class="btn btn-primary" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Create action
        </button>
        <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
          <span class="sr-only">{{"TOGGLE_DROPDOWN" | translate}}</span>
        </button>
        <div class="dropdown-menu">
          <a class="dropdown-item" routerLink="/preparedness/create-edit-preparedness">{{"CREATE_CUSTOM_ACTIONS" | translate}}</a>
          <a class="dropdown-item" routerLink="/preparedness/select">{{"SELECT_FROM_GENERIC_ACTIONS" | translate}}</a>
        </div>
      </div>
    </div>


    <!--
             START :: FILTERS
    -->
    <div class="row align-items-center Filter-form">
      <div class="col-lg-1 col-md-1 col-sm-6">
        Filter:
      </div>
      <div class="col-lg-2 col-md-2 col-sm-6">
        <!-- STATUS -->
        <select class="form-control" id="ActionStatusFilter" [(ngModel)]="filterStatus">
          <option value="-1" selected>{{"ACTION_STATUS" | translate}}</option>
          <option *ngFor="let x of ACTION_STATUS; let i = index" [attr.data-index]="i" value="{{i}}">{{ACTION_STATUS[i]
            | translate}}
          </option>
        </select>
      </div>
      <div class="col-lg-2 col-md-2 col-sm-6 ">
        <!-- DEPARTMENTS -->
        <select class="form-control" id="DepartmentsFilter" [(ngModel)]="filterDepartment">
          <option value="-1" selected>{{ALL_DEPARTMENTS | translate}}</option>
          <option *ngFor="let x of DEPARTMENTS" value="{{x.id}}">{{x.name}}</option>
        </select>
      </div>
      <div class="col-lg-2 col-md-2 col-sm-6 ">
        <!-- TYPE -->
        <select class="form-control" id="TypesFilter" [(ngModel)]="filterType">
          <option value="-1" selected>{{"ALL_TYPES" | translate}}</option>
          <option *ngFor="let x of ACTION_TYPE; let i = index" [attr.data-index]="i" value="{{i}}">{{ACTION_TYPE[i] |
            translate}}
          </option>
        </select>
      </div>
      <div class="col-lg-2 col-md-2 col-sm-6 ">
        <!-- ASSIGNED TOO -->
        <select class="form-control" id="AssignedFilter" [(ngModel)]="filterAssigned">
          <option value="-1">{{"UNASSIGNED" | translate}}</option>
          <option value="0">{{"ASSIGNED_TO_ANYONE" | translate}}</option>
          <!-- If it's me, show "Assigned to me" instead -->
          <option *ngFor="let x of ASSIGNED_TOO; let i = index" [attr.data-index]="i" value="{{x.id}}">{{x.isMe ?
            'Assigned to me' : x.firstName + ' ' + x.lastName}}
          </option>
        </select>
      </div>
      <div class="col-lg-3 col-md-3 col-sm-6 ">
        <select class="form-control" id="AgencyNetworkFilter" [(ngModel)]="filerNetworkAgency">
          <option value="-1" disabled selected hidden>{{"AGENCY_AND_NETWORKS" | translate}}</option>
          <option value="Agency-Only">{{"AGENCY_ONLY" | translate}}</option>
          <option value="All-Networks">{{"ALL_NETWORKS" | translate}}</option>
          <option value="Start-Network">{{"START_NETWORK" | translate}}</option>
        </select>
      </div>
    </div>

    <!--
             START :: INACTIVE
    -->
    <div class="Ribbon__section__wrap Spaced">
      <h2>{{"INACTIVE_ACTIONS" | translate}}</h2>

      <div *ngFor="let action of prepActionService.actions">
        <!-- FILTERING IF STATEMENT -->
        <div *ngIf="(filterType == -1 || action.type == filterType) &&
                    (filterDepartment == -1 || action.department == filterDepartment) &&
                    (filterAssigned == '0' || action.asignee == filterAssigned || ((action.asignee == '' || action.asignee == null) && filterAssigned == '-1')) &&
                    (filterStatus == -1 || filterStatus == ActionStatus.Inactive)">
          <!-- BELONGING IN THE MODULE IF STATEMENT -->
          <div *ngIf="!action.isArchived && !action.isRedAlertActive(hazardRedAlert)">

            <div class="Accordion Preparedness-list">
              <div class="row Preparedness-list__item">
                <div class="col-md-2 col-sm-2 border-right Preparedness-list__item--date">{{"DUE_ON" | translate}} <strong>{{action.dueDate
                  != null ? (action.dueDate
                  | date:"d MMM ''yy") : '-'}}</strong></div>
                <div class="col-md-10 col-sm-10">
                  <div class="row">
                    <div class="col-md-5 col-sm-4" (click)="checkIfLink(action.task)">{{action.task}}</div>
                    <div class="col-md-2 col-sm-2 text-muted">
                   <span class="fa-stack">
                      <i class="fa fa-circle fa-stack-2x"></i>
                      <i class="fa fa-stack-1x fa-inverse fa-times"></i>
                  </span>{{ACTION_STATUS[3] | translate}}
                    </div>
                    <div class="col-md-1 col-sm-1 text-primary Preparedness-list__item--entries">

                      <a href="javascript:void(0)" class="text-primary" data-toggle="collapse"
                         [attr.data-target]="'#notes_popover_' + action.id" aria-expanded="false"
                         [attr.aria-controls]="'notes_popover_' + action.id">
                        <div class="fa-stack">
                          <i class="fa fa-comment fa-stack-2x"></i>
                          <i class="fa fa-stack-1x fa-inverse">{{action.notes.length}}</i>
                        </div>
                        <span>{{"GLOBAL.NOTES" | translate}}</span>
                      </a>

                    </div>
                    <div class="col-md-1 col-sm-1 text-primary Preparedness-list__item--entries">

                      <a href="javascript:void(0)" class="text-primary" data-toggle="collapse"
                         [attr.data-target]="'#documents_popover_' + action.id" aria-expanded="false"
                         [attr.aria-controls]="'documents_popover_' + action.id" *ngIf="action.documents.length > 0">
                        <div class="fa-stack">
                          <i class="fa fa-file fa-stack-2x"></i>
                          <i class="fa fa-stack-1x fa-inverse">{{action.documents.length}}</i>
                        </div>
                        <span>{{"DOC" | translate}}</span>
                      </a>

                    </div>
                    <div class="col-md-3 col-sm-4 btn-block" *ngIf="!countrySelected">{{"INACTIVE_UNTIL_RED_ALERT_LEVEL" | translate}}

                      <a
                        *ngIf="!((action.level == actionLevelEnum.MPA && action.type == ActionType.custom && !permissionsAreEnabled.customMPA.Edit) || (action.level == actionLevelEnum.APA && action.type == ActionType.custom && !permissionsAreEnabled.customAPA.Edit))"
                        [routerLink]="['/preparedness/create-edit-preparedness', action.id]" class="btn btn-block">Edit
                        action</a>
                    </div>
                    <div class="col-md-3 col-sm-4 btn-block"
                         *ngIf="isViewing && (action.type == ActionType.custom || (action.type == ActionType.mandated && !isSameAgency))">
                      <a href="javascript:void(0)" (click)="copyAction(action)"
                         class="btn btn-outline-primary btn-block ">{{"COPY_ACTION" | translate}}</a>
                    </div>
                  </div>
                  <div class="row">
                    <div class="subrow-line">{{"AGENCY_ADMIN.SETTINGS.RESPONSE_PLAN_SECTION_SETTINGS.BUDGET" | translate}}: <strong>&pound;{{action.budget}}</strong></div>
                    <div class="subrow-line">{{"TYPE" | translate}}: <strong>{{ACTION_TYPE[action.type] | translate}}</strong></div>
                    <div class="subrow-line">{{"GLOBAL.DEPARTMENT" | translate}}: <strong>{{DEPARTMENT_MAP.get(action.department)}}</strong>
                    </div>
                    <div class="subrow-line">{{"ASSIGNED_TO" | translate}}: <strong>{{CURRENT_USERS.get(action.asignee) != null ?
                      CURRENT_USERS.get(action.asignee).firstName + ' ' + CURRENT_USERS.get(action.asignee).lastName :
                      'Unassigned'}}</strong></div>

                  </div>
                </div>

                <div id="notes_popover_{{action.id}}"
                     class="Popover__ribbon prevent_parent_collapse collapse col-12 notes-popover">
                  <!-- Notes -->
                  <div class="row Spaced">
                    <div class="col-md-2"></div>
                    <div class="col-md-7">
                      <div class="row">
                        <div class="col-3">
                          <h4>{{"GLOBAL.NOTES" | translate}}</h4>
                        </div>
                        <div class="col-9">
                          <p>
                            <tooltip
                              [level1]="'TOOLTIPS.PREPAREDNESS.TT5.LEVEL1'">
                            </tooltip>
                          </p>
                        </div>
                      </div>
                      <div class="row" *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || permissionsAreEnabled.notes.New || (action.noteId != null && action.noteId != '')">
                        <div class="col-12 form-group" *ngIf="!isViewing">
                        <textarea name="confirm_complete" cols="40" rows="4" class="form-control"
                                  placeholder="Add a completion note here" [(ngModel)]="action.note"></textarea>
                        </div>
                      </div>
                      <div class="row notes-popover__item Small-spaced" *ngFor="let note of action.notes">
                        <div class="col-sm-3">{{note.time | date:"d MMM yyyy"}}</div>
                        <div class="col-sm-9">
                          <div class="row">
                            <div class="col-12">
                              {{note.content}}
                            </div>
                          </div>
                          <div class="row align-items-center">
                            <div class="col-6 text-bold Small-spaced">
                              {{"BY" | translate}} {{CURRENT_USERS.get(note.uploadedBy) != null ?
                              CURRENT_USERS.get(note.uploadedBy).firstName + ' ' +
                              CURRENT_USERS.get(note.uploadedBy).lastName : 'Unassigned'}}
                            </div>
                            <div class="col-6 text-bold text-right"
                                 *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || note.uploadedBy == uid && note.id != action.noteId">
                              <a *ngIf="(note.uploadedBy == uid && permissionsAreEnabled.notes.Edit)"
                                 href="javascript:void(0);" class="text-primary"
                                 (click)="editNote(note, action)">Edit</a>
                              | <a *ngIf="(note.uploadedBy == uid && permissionsAreEnabled.notes.Delete)"
                                   href="javascript:void(0);" class="text-danger"
                                   (click)="deleteNote(note, action)">{{"DELETE" | translate}}</a>
                            </div>
                            <div class="col-6 text-bold text-right" *ngIf="note.id == action.noteId">
                              {{"EDITING" | translate}}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3 btn-block" *ngIf="!isViewing">
                      <a *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || permissionsAreEnabled.notes.New || (action.noteId != null && action.noteId != '')"
                         href="javascript:void(0)" class="btn btn-primary btn-block"
                         (click)="addNote(action)">{{action.noteId != null && action.noteId != ''? 'SAVE NOTE' :
                        'ADD NOTE'}}</a>
                      <a href="javascript:void(0)" class="btn btn-block" (click)="disableEditNote(action)"
                         onClick="$(this).parent().parent().parent().collapse('hide')">{{"GLOBAL.CANCEL" | translate}}</a>
                      <a href="javascript:void(0)" class="btn btn-block" (click)="disableEditNote(action)"
                         *ngIf="action.noteId != null && action.noteId != ''"1>{{"STOP_EDITING" | translate}}</a>
                    </div>
                  </div>

                </div>

                <div id="documents_popover_{{action.id}}"
                     class="Popover__ribbon prevent_parent_collapse collapse col-12 documents-popover">
                  <!-- Documents -->
                  <div class="row Spaced">
                    <div class="col-md-2"></div>
                    <div class="col-md-10">
                      <div class="row Spaced align-items-center">
                        <div class="col-sm-6 col-8">
                          <h4>Documents ({{action.documents.length}})</h4>&nbsp;&nbsp;<a
                          *ngIf="userType == userTypes.CountryAdmin" href="javascript:void(0);"
                          class="text-nowrap"
                          (click)="exportAllDocuments(action)">{{"DOWNLOAD_ALL" | translate}}</a>
                        </div>
                        <div class="col-sm-6 col-4 text-right">
                          <a (click)="closeDocumentsModal('documents_popover_' + action.id)"
                             href="javascript:void(0)" class="btn btn-block">{{"GLOBAL.CLOSE" | translate}}</a>
                        </div>
                      </div>
                      <div class="row documents-popover__item">
                        <div class="col-12">
                          <p *ngFor="let doc of action.documents; let i = index" [attr.data-index]="i">
                            <strong>{{action.documents[i].fileName}}</strong>&nbsp;&nbsp;<span><a
                            *ngIf="(uid == doc.uploadedBy || userType == userTypes.CountryAdmin) || permissionsAreEnabled.other.DownloadDocuments"
                            href="javascript:void(0);" (click)="exportDocument(action, i)">{{"DOWNLOAD" | translate}}</a> |
                                <a *ngIf="uid == doc.uploadedBy || userType == userTypes.CountryAdmin"
                                   href="javascript:void(0);" class="text-danger"
                                   (click)="deleteDocument(action, doc.documentId)">{{"DELETE" | translate}}</a></span>
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="popover_content_{{action.key}}"
                 class="Popover__ribbon prevent_parent_collapse collapse col-12 Popover__ribbon__no-arrow">
              <!-- Mark as complete -->
              <div class="row Spaced">
                <div class="col-md-2"></div>
                <div class="col-md-7">
                  <div class="row">
                    <div class="col-12">
                      <h4>{{"CONFIRM_THIS_ACTION_IS_COMPLETED" | translate}}</h4>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-12 form-group">
                    <textarea name="confirm_complete" cols="40" rows="4" class="form-control"
                              placeholder="{{'ADD_A_COMPLETION_NOTE_HERE' | translate}}" [(ngModel)]="action.note"></textarea>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-12">
                      <p>{{"ATTACH_DOCUMENTS_AS_PROOF_OF_COMPLETION" | translate}} {{action.requireDoc ? '(required)' : ''}}</p>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-12"><label for="docUpload" class="btn btn-outline-primary">{{"UPLOAD_DOCUMENTS" | translate}}</label>
                    </div>
                    <input type='file' id="docUpload" (change)="fileChange($event, action)" class="Input-form--hidden"/>
                  </div>
                  <div class="row Spaced">
                    <div class="col-12">
                      <p *ngIf="action.documents && action.documents.length > 0">{{"ATTACHMENTS" | translate}}</p>
                      <p *ngFor="let attachment of action.documents">
                        <strong>{{attachment.name}}</strong>&nbsp;&nbsp;<a href="javascript:void(0)" class="text-danger"
                                                                           (click)="removeAttachment(action, attachment)">{{"GLOBAL.REMOVE" | translate}}</a>
                      </p>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 btn-block">
                  <a href="javascript:void(0)" class="btn btn-primary btn-block"
                     (click)="completeAction(action)">{{CONFIRM | translate}}</a>
                  <a href="javascript:void(0)" class="btn btn-block"
                     onClick="$(this).parent().parent().parent().collapse('hide')">{{"GLOBAL.CANCEL" | translate}}</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>


    <!--
             START :: ASSIGNED TOO
    -->
    <div class="Ribbon__section__wrap Spaced">
      <h2>Actions assigned to {{
        filterAssigned == uid ? 'me' : (filterAssigned == '0' ? 'anyone' :
        (CURRENT_USERS.get(filterAssigned) != null ? CURRENT_USERS.get(filterAssigned).firstName + ' ' +
        CURRENT_USERS.get(filterAssigned).lastName : 'no-one')
        )
        }}</h2>

      <div *ngFor="let action of prepActionService.actions">

        <!-- FILTERING IF STATEMENT -->
        <div *ngIf="!isViewing">
          <div *ngIf="(filterType == -1 || action.type == filterType) &&
                    (filterDepartment == -1 || action.department == filterDepartment) &&
                    (filterAssigned == '0' || action.asignee == filterAssigned || ((action.asignee == '' || action.asignee == null) && filterAssigned == '-1')) &&
                    (filterStatus == -1 || filterStatus == ActionStatus.InProgress || filterStatus == ActionStatus.Completed || filterStatus == ActionStatus.Expired)">

            <!-- BELONGING IN THE MODULE IF STATEMENT -->
            <div
              *ngIf="!action.isArchived && (!(action.asignee == '' || action.asignee == undefined || action.asignee == null)) && action.isRedAlertActive(hazardRedAlert)">

            <!-- FILTERING BASED ON THE "COMPLETE/INPROGRESS/EXPIRED" filter -->
            <!-- Use the logic from the status block to determine this -->
            <div *ngIf="filterStatus == -1 ||
            ((action.asignee != '' && action.asignee != null && action.isComplete && (action.isCompleteAt + action.computedClockSetting > getNow())) && filterStatus == ActionStatus.Completed) ||
            ((action.asignee != '' && action.asignee != null && !action.isComplete && (action.updatedAt + action.computedClockSetting > getNow())) && filterStatus == ActionStatus.InProgress) ||
            ((!(action.asignee != '' && action.asignee != null && !action.isComplete && (action.updatedAt + action.computedClockSetting > getNow())) && !(action.asignee != '' && action.asignee != null && action.isComplete && (action.isCompleteAt + action.computedClockSetting > getNow()))) && filterStatus == ActionStatus.Expired)">

                <div class="Accordion Preparedness-list">
                  <div class="Accordion Preparedness-list">
                    <div class="row Preparedness-list__item">


                      <!--
                     Everywhere that the following line is used it's just way of handling the "Expired on" state with the clock settings.
                     Based on those setting they're sometimes expired. This below checks that. It makes all the IF statements look
                     a bit messy but it has to be done like this so it's not dependent on a method resolution (and hence live updating gets a bit weird)

                     (actcalculatedIsCompletelete && (action.isCompleteAt + action.computedClockSetting < getNow())) || (!actcalculatedIsCompletelete && (action.updatedAt + action.computedClockSetting < getNow()))
                      -->

                      <!-- Logic for the clock settings -->
                      <div class="col-md-2 col-sm-2 border-right Preparedness-list__item--date"
                           *ngIf="!action.isComplete && ((action.updatedAt + action.computedClockSetting) >= getNow())">
                        Due on <strong>{{action.dueDate != null ? (action.dueDate | date:"d MMM ''yy") : '-'}}</strong>
                      </div>
                      <div class="col-md-2 col-sm-2 border-right Preparedness-list__item--date"
                           *ngIf="!action.isComplete && ((action.updatedAt + action.computedClockSetting) < getNow())">
                        Expired on <strong>{{(action.updatedAt + action.computedClockSetting) | date:"d MMM
                        ''yy"}}</strong>
                      </div>
                      <div class="col-md-2 col-sm-2 border-right Preparedness-list__item--date"
                           *ngIf="action.isComplete && ((action.isCompleteAt + action.computedClockSetting) < getNow())">
                        Expired on <strong>{{(action.isCompleteAt + action.computedClockSetting) | date:"d MMM
                        ''yy"}}</strong>
                      </div>
                      <div class="col-md-2 col-sm-2 border-right Preparedness-list__item--date"
                           *ngIf="action.isComplete && ((action.isCompleteAt + action.computedClockSetting) >= getNow())">
                        Expires on <strong>{{(action.isCompleteAt + action.computedClockSetting) | date:"d MMM
                        ''yy"}}</strong>
                      </div>


                      <div class="col-md-10 col-sm-10">
                        <div class="row">
                          <div class="col-md-5 col-sm-4" (click)="checkIfLink(action.task)">{{action.task}}</div>
                          <div class="col-md-2 col-sm-2"
                               [ngClass]="
                                         {
                                         'text-warning': action.asignee != '' && action.asignee != null && !action.isComplete && (action.updatedAt + action.computedClockSetting > getNow()),
                                         'text-success': action.asignee != '' && action.asignee != null && action.isComplete && (action.isCompleteAt + action.computedClockSetting > getNow()),
                                         'text-danger': !(action.asignee != '' && action.asignee != null && !action.isComplete && (action.updatedAt + action.computedClockSetting > getNow())) && !(action.asignee != '' && action.asignee != null && action.isComplete && (action.isCompleteAt + action.computedClockSetting > getNow()))
                                         }
                                         ">
                                         <span class="fa-stack">
                                            <i class="fa fa-circle fa-stack-2x"></i>
                                            <i class="fa fa-stack-1x fa-inverse"
                                               [ngClass]="
                                               {
                                               'fa-ellipsis-h': action.asignee != '' && action.asignee != null && !action.isComplete && (action.updatedAt + action.computedClockSetting > getNow()),
                                               'fa-check': action.asignee != '' && action.asignee != null && action.isComplete && (action.isCompleteAt + action.computedClockSetting > getNow()),
                                               'fa-times': !(action.asignee != '' && action.asignee != null && !action.isComplete && (action.updatedAt + action.computedClockSetting > getNow())) && !(action.asignee != '' && action.asignee != null && action.isComplete && (action.isCompleteAt + action.computedClockSetting > getNow()))
                                               }
                                               "></i>
                                        </span>
                            {{ACTION_STATUS[
                            action.asignee != '' && action.asignee != null && !action.isComplete && (action.updatedAt +
                            action.computedClockSetting > getNow()) ? 1 :
                            ((action.asignee != '' && action.asignee != null && action.isComplete &&
                            (action.isCompleteAt + action.computedClockSetting > getNow())) ? 2 : 0)] | translate}}
                          </div>
                          <div class="col-md-1 col-sm-1 text-primary Preparedness-list__item--entries">

                            <a href="javascript:void(0)" class="text-primary" data-toggle="collapse"
                               [attr.data-target]="'#notes_popover_' + action.id" aria-expanded="false"
                               [attr.aria-controls]="'notes_popover_' + action.id">
                              <div class="fa-stack">
                                <i class="fa fa-comment fa-stack-2x"></i>
                                <i class="fa fa-stack-1x fa-inverse">{{action.notes.length}}</i>
                              </div>
                              <span>{{"GLOBAL.NOTES" | translate}}</span>
                            </a>

                          </div>
                          <div class="col-md-1 col-sm-1 text-primary Preparedness-list__item--entries">

                            <a href="javascript:void(0)" class="text-primary" data-toggle="collapse"
                               [attr.data-target]="'#documents_popover_' + action.id" aria-expanded="false"
                               [attr.aria-controls]="'documents_popover_' + action.id"
                               *ngIf="action.documents.length > 0">
                              <div class="fa-stack">
                                <i class="fa fa-file fa-stack-2x"></i>
                                <i class="fa fa-stack-1x fa-inverse">{{action.documents.length}}</i>
                              </div>
                              <span>{{"DOC" | translate}}</span>
                            </a>

                        </div>
                        <div class="col-md-3 col-sm-4 btn-block"
                             *ngIf="!countrySelected">
                          <div *ngIf="!action.isComplete && !(!action.isComplete && (action.updatedAt + action.computedClockSetting < getNow())) && action.asignee == uid">
                            <a href="javascript:void(0)" data-toggle="collapse"
                               [attr.data-target]="'#popover_content_' + action.id" aria-expanded="false"
                               aria-controls="popover_content"
                               class="btn btn-outline-primary btn-block ">{{"MARK_AS_COMPLETE" | translate}}</a>
                          </div>

                            <a
                              *ngIf="!((action.level == actionLevelEnum.MPA && action.type == ActionType.custom && !permissionsAreEnabled.customMPA.Edit) || (action.level == actionLevelEnum.APA && action.type == ActionType.custom && !permissionsAreEnabled.customAPA.Edit))"
                              [routerLink]="['/preparedness/create-edit-preparedness', action.id]"
                              class="btn btn-block">Edit
                              action</a>
                          </div>
                          <div class="col-md-3 col-sm-4 btn-block"
                               *ngIf="isViewing && (action.type == ActionType.custom || (action.type == ActionType.mandated && !isSameAgency))">
                            <a href="javascript:void(0)" (click)="copyAction(action)"
                               class="btn btn-outline-primary btn-block ">{{"COPY_ACTION" | translate}}</a>
                          </div>
                        </div>
                        <div class="row">
                          <div class="subrow-line">{{"AGENCY_ADMIN.SETTINGS.RESPONSE_PLAN_SECTION_SETTINGS.BUDGET" | translate}}: <strong>&pound;{{action.budget}}</strong></div>
                          <div class="subrow-line">{{"TYPE" | translate}}: <strong>{{ACTION_TYPE[action.type] | translate}}</strong></div>
                          <div class="subrow-line">{{"GLOBAL.DEPARTMENT" | translate}}:
                            <strong>{{DEPARTMENT_MAP.get(action.department)}}</strong></div>
                          <div class="subrow-line">{{"ASSIGNED_TO" | translate}}: <strong>{{CURRENT_USERS.get(action.asignee) != null ?
                            CURRENT_USERS.get(action.asignee).firstName + ' ' +
                            CURRENT_USERS.get(action.asignee).lastName
                            : 'Unassigned'}}</strong></div>

                        </div>
                      </div>

                      <div id="notes_popover_{{action.id}}"
                           class="Popover__ribbon prevent_parent_collapse collapse col-12 notes-popover">
                        <!-- Notes -->
                        <div class="row Spaced">
                          <div class="col-md-2"></div>
                          <div class="col-md-7">
                            <div class="row">
                              <div class="col-3">
                                <h4>{{"GLOBAL.NOTES" | translate}}</h4>
                              </div>
                              <div class="col-9">
                                <p>
                                  <tooltip
                                    [level1]="'TOOLTIPS.PREPAREDNESS.TT5.LEVEL1'">
                                  </tooltip>
                                </p>
                              </div>
                            </div>
                            <div class="row" *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || permissionsAreEnabled.notes.New || (action.noteId != null && action.noteId != '')">
                              <div class="col-12 form-group" *ngIf="!isViewing">
                        <textarea name="confirm_complete" cols="40" rows="4" class="form-control"
                                  placeholder="{{'ADD_A_COMPLETION_NOTE_HERE' | translate}}" [(ngModel)]="action.note"></textarea>
                              </div>
                            </div>
                            <div class="row notes-popover__item Small-spaced" *ngFor="let note of action.notes">
                              <div class="col-sm-3">{{note.time | date:"d MMM yyyy"}}</div>
                              <div class="col-sm-9">
                                <div class="row">
                                  <div class="col-12">
                                    {{note.content}}
                                  </div>
                                </div>
                                <div class="row align-items-center">
                                  <div class="col-6 text-bold Small-spaced">
                                    by {{CURRENT_USERS.get(note.uploadedBy) != null ?
                                    CURRENT_USERS.get(note.uploadedBy).firstName + ' ' +
                                    CURRENT_USERS.get(note.uploadedBy).lastName : 'Unassigned'}}
                                  </div>
                                  <div class="col-6 text-bold text-right"
                                       *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || note.uploadedBy == uid && note.id != action.noteId">
                                    <a *ngIf="(note.uploadedBy == uid && permissionsAreEnabled.notes.Edit)"
                                       href="javascript:void(0);" class="text-primary"
                                       (click)="editNote(note, action)">{{"EDIT" | translate}}</a>
                                    | <a *ngIf="(note.uploadedBy == uid && permissionsAreEnabled.notes.Delete)"
                                         href="javascript:void(0);" class="text-danger"
                                         (click)="deleteNote(note, action)">{{"DELETE" | translate}}</a>
                                  </div>
                                  <div class="col-6 text-bold text-right" *ngIf="note.id == action.noteId">
                                    {{"EDITING" | translate}}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-3 btn-block" *ngIf="!isViewing">
                            <a *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || permissionsAreEnabled.notes.New || (action.noteId != null && action.noteId != '')"
                               href="javascript:void(0)" class="btn btn-primary btn-block"
                               (click)="addNote(action)">{{action.noteId != null && action.noteId != ''? 'SAVE NOTE' :
                              'ADD NOTE'}}</a>
                            <a href="javascript:void(0)" class="btn btn-block" (click)="disableEditNote(action)"
                               onClick="$(this).parent().parent().parent().collapse('hide')">{{"GLOBAL.CANCEL" | translate}}</a>
                            <a href="javascript:void(0)" class="btn btn-block" (click)="disableEditNote(action)"
                               *ngIf="action.noteId != null && action.noteId != ''">{{"STOP_EDITING" | translate}}</a>
                          </div>
                        </div>

                      </div>

                      <div id="documents_popover_{{action.id}}"
                           class="Popover__ribbon prevent_parent_collapse collapse col-12 documents-popover">
                        <!-- Documents -->
                        <div class="row Spaced">
                          <div class="col-md-2"></div>
                          <div class="col-md-10">
                            <div class="row Spaced align-items-center">
                              <div class="col-sm-6 col-8">
                                <h4>{{"DOCUMENTS_TEXT" | translate}} ({{action.documents.length}})</h4>&nbsp;&nbsp;<a
                                *ngIf="userType == userTypes.CountryAdmin" href="javascript:void(0);"
                                class="text-nowrap"
                                (click)="exportAllDocuments(action)">{{"DOWNLOAD_ALL" | translate}}</a>
                              </div>
                              <div class="col-sm-6 col-4 text-right">
                                <a (click)="closeDocumentsModal('documents_popover_' + action.id)"
                                   href="javascript:void(0)" class="btn btn-block">{{"GLOBAL.CLOSE" | translate}}</a>
                              </div>
                            </div>
                            <div class="row documents-popover__item">
                              <div class="col-12">
                                <p *ngFor="let doc of action.documents; let i = index" [attr.data-index]="i">
                                  <strong>{{action.documents[i].fileName}}</strong>&nbsp;&nbsp;<span><a
                                  *ngIf="(uid == doc.uploadedBy || userType == userTypes.CountryAdmin) || permissionsAreEnabled.other.DownloadDocuments"
                                  href="javascript:void(0);" (click)="exportDocument(action, i)">{{"DOWNLOAD" | translate}}</a> |
                                <a *ngIf="uid == doc.uploadedBy || userType == userTypes.CountryAdmin"
                                   href="javascript:void(0);" class="text-danger"
                                   (click)="deleteDocument(action, doc.documentId)">{{"DELETE" | translate}}</a></span>
                                </p>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div id="popover_content_{{action.id}}"
                       class="Popover__ribbon prevent_parent_collapse collapse col-12 Popover__ribbon__no-arrow">
                    <!-- Mark as complete -->
                    <div class="row Spaced">
                      <div class="col-md-2"></div>
                      <div class="col-md-7">
                        <div class="row">
                          <div class="col-12">
                            <h4>{{"CONFIRM_THIS_ACTION_IS_COMPLETED" | translate}}</h4>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-12 form-group">
                    <textarea name="confirm_complete" cols="40" rows="4" class="form-control"
                              placeholder="{{'ADD_A_COMPLETION_NOTE_HERE' | translate}}" [(ngModel)]="action.note"></textarea>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-12">
                            <p>{{"ATTACH_DOCUMENTS_AS_PROOF_OF_COMPLETION" | translate}} {{action.requireDoc ? '(required)' : ''}}</p>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-12"><label for="docUpload{{action.id}}" class="btn btn-outline-primary">{{"UPLOAD_DOCUMENTS" | translate}}</label>
                          </div>
                          <input type='file' id="docUpload{{action.id}}" name="file"
                                 (change)="fileChange($event, action, action.id)"
                                 class="Input-form--hidden"/>
                        </div>
                        <div class="row Spaced">
                          <div class="col-12">
                            <p *ngIf="action.attachments && action.attachments.length > 0">{{"ATTACHMENTS" | translate}}
                              ({{action.attachments.length}})</p>
                            <p *ngFor="let attachment of action.attachments">
                              <strong>{{attachment.name}}</strong>&nbsp;&nbsp;<a href="javascript:void(0)"
                                                                                 class="text-danger"
                                                                                 (click)="removeAttachment(action, attachment)">{{"GLOBAL.REMOVE" | translate}}</a>
                            </p>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3 btn-block">
                        <a href="javascript:void(0)" class="btn btn-primary btn-block"
                           (click)="completeAction(action)">{{"CONFIRM" | translate}}</a>
                        <a href="javascript:void(0)" class="btn btn-block"
                           onClick="$(this).parent().parent().parent().collapse('hide')">{{"GLOBAL.CANCEL" | translate}}</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="isViewing">
          <div *ngIf="(filterType == -1 || action.type == filterType) &&
                     userType != UserType.GlobalDirector && userType != UserType.RegionalDirector &&
                    !(privacy?.chs != Privacy.Public && action.type == ActionType.chs) &&
                    (filterDepartment == -1 || action.department == filterDepartment) &&
                    (filterAssigned == '0' || action.asignee == filterAssigned || ((action.asignee == '' || action.asignee == null) && filterAssigned == '-1')) &&
                    (filterStatus == -1 || filterStatus == ActionStatus.InProgress || filterStatus == ActionStatus.Completed || filterStatus == ActionStatus.Expired) ||
                    (filterType == -1 || action.type == filterType) && (userType == UserType.GlobalDirector || userType == UserType.RegionalDirector || isSameAgency) &&
                    (filterDepartment == -1 || action.department == filterDepartment) &&
                    (filterAssigned == '0' || action.asignee == filterAssigned || ((action.asignee == '' || action.asignee == null) && filterAssigned == '-1')) &&
                    (filterStatus == -1 || filterStatus == ActionStatus.InProgress || filterStatus == ActionStatus.Completed || filterStatus == ActionStatus.Expired)">

            <!-- BELONGING IN THE MODULE IF STATEMENT -->
            <div
              *ngIf="!action.isArchived && (!(action.asignee == '' || action.asignee == undefined || action.asignee == null)) && action.isRedAlertActive(hazardRedAlert)">

              <!-- FILTERING BASED ON THE "COMPLETE/INPROGRESS/EXPIRED" filter -->
              <div *ngIf="filterStatus == -1 ||
            (!action.isComplete && action.dueDate > getNow() && !((!action.isComplete && (action.updatedAt + action.computedClockSetting < getNow()))
                      || (action.isComplete && (action.isCompleteAt + action.computedClockSetting < getNow()))) && filterStatus == ActionStatus.InProgress) ||
            (action.isComplete && action.dueDate > getNow() && filterStatus == ActionStatus.Completed) ||
            ((action.dueDate <= getNow()
                      || (!action.isComplete && (action.updatedAt + action.computedClockSetting < getNow()))
                      || (action.isComplete && (action.isCompleteAt + action.computedClockSetting < getNow()))) && filterStatus == ActionStatus.Expired)">

                <div class="Accordion Preparedness-list">
                  <div class="Accordion Preparedness-list">
                    <div class="row Preparedness-list__item">


                      <!--
                     Everywhere that the following line is used it's just way of handling the "Expired on" state with the clock settings.
                     Based on those setting they're sometimes expired. This below checks that. It makes all the IF statements look
                     a bit messy but it has to be done like this so it's not dependent on a method resolution (and hence live updating gets a bit weird)

                     (actcalculatedIsCompletelete && (action.isCompleteAt + action.computedClockSetting < getNow())) || (!actcalculatedIsCompletelete && (action.updatedAt + action.computedClockSetting < getNow()))
                      -->

                      <!-- Logic for the clock settings -->
                      <div class="col-md-2 col-sm-2 border-right Preparedness-list__item--date"
                           *ngIf="!action.isComplete && ((action.updatedAt + action.computedClockSetting) >= getNow())">
                        Due on <strong>{{action.dueDate != null ? (action.dueDate | date:"d MMM ''yy") : '-'}}</strong>
                      </div>
                      <div class="col-md-2 col-sm-2 border-right Preparedness-list__item--date"
                           *ngIf="!action.isComplete && ((action.updatedAt + action.computedClockSetting) < getNow())">
                        Expired on <strong>{{(action.updatedAt + action.computedClockSetting) | date:"d MMM
                        ''yy"}}</strong>
                      </div>
                      <div class="col-md-2 col-sm-2 border-right Preparedness-list__item--date"
                           *ngIf="action.isComplete && ((action.isCompleteAt + action.computedClockSetting) < getNow())">
                        Expired on <strong>{{(action.isCompleteAt + action.computedClockSetting) | date:"d MMM
                        ''yy"}}</strong>
                      </div>
                      <div class="col-md-2 col-sm-2 border-right Preparedness-list__item--date"
                           *ngIf="action.isComplete && ((action.isCompleteAt + action.computedClockSetting) >= getNow())">
                        Expires on <strong>{{(action.isCompleteAt + action.computedClockSetting) | date:"d MMM
                        ''yy"}}</strong>
                      </div>


                      <div class="col-md-10 col-sm-10">
                        <div class="row">
                          <div class="col-md-5 col-sm-4" (click)="checkIfLink(action.task)">{{action.task}}</div>
                          <div class="col-md-2 col-sm-2"
                               [ngClass]="
                                         {
                                         'text-warning': action.asignee != '' && action.asignee != null && !action.isComplete && (action.updatedAt + action.computedClockSetting > getNow()),
                                         'text-success': action.asignee != '' && action.asignee != null && action.isComplete && (action.isCompleteAt + action.computedClockSetting > getNow()),
                                         'text-danger': !(action.asignee != '' && action.asignee != null && !action.isComplete && (action.updatedAt + action.computedClockSetting > getNow())) && !(action.asignee != '' && action.asignee != null && action.isComplete && (action.isCompleteAt + action.computedClockSetting > getNow()))
                                         }
                                         ">
                                         <span class="fa-stack">
                                            <i class="fa fa-circle fa-stack-2x"></i>
                                            <i class="fa fa-stack-1x fa-inverse"
                                               [ngClass]="
                                               {
                                               'fa-ellipsis-h': action.asignee != '' && action.asignee != null && !action.isComplete && (action.updatedAt + action.computedClockSetting > getNow()),
                                               'fa-check': action.asignee != '' && action.asignee != null && action.isComplete && (action.isCompleteAt + action.computedClockSetting > getNow()),
                                               'fa-times': !(action.asignee != '' && action.asignee != null && !action.isComplete && (action.updatedAt + action.computedClockSetting > getNow())) && !(action.asignee != '' && action.asignee != null && action.isComplete && (action.isCompleteAt + action.computedClockSetting > getNow()))
                                               }
                                               "></i>
                                        </span>
                            {{ACTION_STATUS[
                            action.asignee != '' && action.asignee != null && !action.isComplete && (action.updatedAt +
                            action.computedClockSetting > getNow()) ? 1 :
                            ((action.asignee != '' && action.asignee != null && action.isComplete &&
                            (action.isCompleteAt + action.computedClockSetting > getNow())) ? 2 : 0)] | translate}}
                          </div>
                          <div class="col-md-1 col-sm-1 text-primary Preparedness-list__item--entries">

                            <a href="javascript:void(0)" class="text-primary" data-toggle="collapse"
                               [attr.data-target]="'#notes_popover_' + action.id" aria-expanded="false"
                               [attr.aria-controls]="'notes_popover_' + action.id">
                              <div class="fa-stack">
                                <i class="fa fa-comment fa-stack-2x"></i>
                                <i class="fa fa-stack-1x fa-inverse">{{action.notes.length}}</i>
                              </div>
                              <span>{{"GLOBAL.NOTES" | translate}}</span>
                            </a>

                          </div>
                          <div class="col-md-1 col-sm-1 text-primary Preparedness-list__item--entries">

                            <a href="javascript:void(0)" class="text-primary" data-toggle="collapse"
                               [attr.data-target]="'#documents_popover_' + action.id" aria-expanded="false"
                               [attr.aria-controls]="'documents_popover_' + action.id"
                               *ngIf="action.documents.length > 0">
                              <div class="fa-stack">
                                <i class="fa fa-file fa-stack-2x"></i>
                                <i class="fa fa-stack-1x fa-inverse">{{action.documents.length}}</i>
                              </div>
                              <span>{{"DOC" | translate}}</span>
                            </a>

                          </div>
                          <div class="col-md-3 col-sm-4 btn-block"
                               *ngIf="!countrySelected">
                            <div
                              *ngIf="!action.isComplete && !(!action.isComplete && (action.updatedAt + action.computedClockSetting < getNow()))">
                              <a href="javascript:void(0)" data-toggle="collapse"
                                 [attr.data-target]="'#popover_content_' + action.id" aria-expanded="false"
                                 aria-controls="popover_content"
                                 class="btn btn-outline-primary btn-block ">{{"MARK_AS_COMPLETE" | translate}}</a>
                            </div>

                            <a
                              *ngIf="!((action.level == actionLevelEnum.MPA && action.type == ActionType.custom && !permissionsAreEnabled.customMPA.Edit) || (action.level == actionLevelEnum.APA && action.type == ActionType.custom && !permissionsAreEnabled.customAPA.Edit))"
                              [routerLink]="['/preparedness/create-edit-preparedness', action.id]"
                              class="btn btn-block">Edit
                              action</a>
                          </div>
                          <div class="col-md-3 col-sm-4 btn-block"
                               *ngIf="isViewing && (action.type == ActionType.custom || (action.type == ActionType.mandated && !isSameAgency))">
                            <a href="javascript:void(0)" (click)="copyAction(action)"
                               class="btn btn-outline-primary btn-block ">{{"COPY_ACTION" | translate}}</a>
                          </div>
                        </div>
                        <div class="row">
                          <div class="subrow-line">{{"AGENCY_ADMIN.SETTINGS.RESPONSE_PLAN_SECTION_SETTINGS.BUDGET" | translate}}: <strong>&pound;{{action.budget}}</strong></div>
                          <div class="subrow-line">{{"TYPE" | translate}}: <strong>{{ACTION_TYPE[action.type] | translate}}</strong></div>
                          <div class="subrow-line">{{"GLOBAL.DEPARTMENT" | translate}}:
                            <strong>{{DEPARTMENT_MAP.get(action.department)}}</strong></div>
                          <div class="subrow-line">{{"ASSIGNED_TO" | translate}}: <strong>{{CURRENT_USERS.get(action.asignee) != null ?
                            CURRENT_USERS.get(action.asignee).firstName + ' ' +
                            CURRENT_USERS.get(action.asignee).lastName
                            : 'Unassigned'}}</strong></div>

                        </div>
                      </div>

                      <div id="notes_popover_{{action.id}}"
                           class="Popover__ribbon prevent_parent_collapse collapse col-12 notes-popover">
                        <!-- Notes -->
                        <div class="row Spaced">
                          <div class="col-md-2"></div>
                          <div class="col-md-7">
                            <div class="row">
                              <div class="col-3">
                                <h4>{{"GLOBAL.NOTES" | translate}}</h4>
                              </div>
                              <div class="col-9">
                                <p>
                                  <tooltip
                                    [level1]="'TOOLTIPS.PREPAREDNESS.TT5.LEVEL1'">
                                  </tooltip>
                                </p>
                              </div>
                            </div>
                            <div class="row" *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || permissionsAreEnabled.notes.New || (action.noteId != null && action.noteId != '')">
                              <div class="col-12 form-group" *ngIf="!isViewing">
                        <textarea name="confirm_complete" cols="40" rows="4" class="form-control"
                                  placeholder="{{'ADD_A_COMPLETION_NOTE_HERE' | translate}}" [(ngModel)]="action.note"></textarea>
                              </div>
                            </div>
                            <div class="row notes-popover__item Small-spaced" *ngFor="let note of action.notes">
                              <div class="col-sm-3">{{note.time | date:"d MMM yyyy"}}</div>
                              <div class="col-sm-9">
                                <div class="row">
                                  <div class="col-12">
                                    {{note.content}}
                                  </div>
                                </div>
                                <div class="row align-items-center">
                                  <div class="col-6 text-bold Small-spaced">
                                    by {{CURRENT_USERS.get(note.uploadedBy) != null ?
                                    CURRENT_USERS.get(note.uploadedBy).firstName + ' ' +
                                    CURRENT_USERS.get(note.uploadedBy).lastName : 'Unassigned'}}
                                  </div>
                                  <div class="col-6 text-bold text-right"
                                       *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || note.uploadedBy == uid && note.id != action.noteId">
                                    <a *ngIf="(note.uploadedBy == uid && permissionsAreEnabled.notes.Edit)"
                                       href="javascript:void(0);" class="text-primary"
                                       (click)="editNote(note, action)">{{"EDIT" | translate}}</a>
                                    | <a *ngIf="(note.uploadedBy == uid && permissionsAreEnabled.notes.Delete)"
                                         href="javascript:void(0);" class="text-danger"
                                         (click)="deleteNote(note, action)">{{"DELETE"| translate}}</a>
                                  </div>
                                  <div class="col-6 text-bold text-right" *ngIf="note.id == action.noteId">
                                    {{"EDITING" | translate}}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-3 btn-block" *ngIf="!isViewing">
                            <a *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || permissionsAreEnabled.notes.New || (action.noteId != null && action.noteId != '')"
                               href="javascript:void(0)" class="btn btn-primary btn-block"
                               (click)="addNote(action)">{{action.noteId != null && action.noteId != ''? 'SAVE NOTE' :
                              'ADD NOTE'}}</a>
                            <a href="javascript:void(0)" class="btn btn-block" (click)="disableEditNote(action)"
                               onClick="$(this).parent().parent().parent().collapse('hide')">{{"GLOBAL.CANCEL" | translate}}</a>
                            <a href="javascript:void(0)" class="btn btn-block" (click)="disableEditNote(action)"
                               *ngIf="action.noteId != null && action.noteId != ''">{{"STOP_EDITING" | translate}}</a>
                          </div>
                        </div>

                      </div>

                      <div id="documents_popover_{{action.id}}"
                           class="Popover__ribbon prevent_parent_collapse collapse col-12 documents-popover">
                        <!-- Documents -->
                        <div class="row Spaced">
                          <div class="col-md-2"></div>
                          <div class="col-md-10">
                            <div class="row Spaced align-items-center">
                              <div class="col-sm-6 col-8">
                                <h4>{{"DOCUMENTS_TEXT" | translate}} ({{action.documents.length}})</h4>&nbsp;&nbsp;<a
                                *ngIf="userType == userTypes.CountryAdmin" href="javascript:void(0);"
                                class="text-nowrap"
                                (click)="exportAllDocuments(action)">Download
                                all</a>
                              </div>
                              <div class="col-sm-6 col-4 text-right">
                                <a (click)="closeDocumentsModal('documents_popover_' + action.id)"
                                   href="javascript:void(0)" class="btn btn-block">{{"GLOBAL.CLOSE" | translate}}</a>
                              </div>
                            </div>
                            <div class="row documents-popover__item">
                              <div class="col-12">
                                <p *ngFor="let doc of action.documents; let i = index" [attr.data-index]="i">
                                  <strong>{{action.documents[i].fileName}}</strong>&nbsp;&nbsp;<span><a
                                  *ngIf="(uid == doc.uploadedBy || userType == userTypes.CountryAdmin) || permissionsAreEnabled.other.DownloadDocuments"
                                  href="javascript:void(0);" (click)="exportDocument(action, i)">{{"DOWNLOAD" | translate}}</a> |
                                <a *ngIf="uid == doc.uploadedBy || userType == userTypes.CountryAdmin"
                                   href="javascript:void(0);" class="text-danger"
                                   (click)="deleteDocument(action, doc.documentId)">{{"DELETE" | translate}}</a></span>
                                </p>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div id="popover_content_{{action.id}}"
                       class="Popover__ribbon prevent_parent_collapse collapse col-12 Popover__ribbon__no-arrow">
                    <!-- Mark as complete -->
                    <div class="row Spaced">
                      <div class="col-md-2"></div>
                      <div class="col-md-7">
                        <div class="row">
                          <div class="col-12">
                            <h4>{{"CONFIRM_THIS_ACTION_IS_COMPLETED" | translate}}</h4>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-12 form-group">
                    <textarea name="confirm_complete" cols="40" rows="4" class="form-control"
                              placeholder="{{'ADD_A_COMPLETION_NOTE_HERE' | translate}}" [(ngModel)]="action.note"></textarea>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-12">
                            <p>{{"ATTACH_DOCUMENTS_AS_PROOF_OF_COMPLETION" | translate}} {{action.requireDoc ? '(required)' : ''}}</p>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-12"><label for="docUpload{{action.id}}" class="btn btn-outline-primary">{{"UPLOAD_DOCUMENTS" | translate}}</label>
                          </div>
                          <input type='file' id="docUpload{{action.id}}" name="file"
                                 (change)="fileChange($event, action, action.id)"
                                 class="Input-form--hidden"/>
                        </div>
                        <div class="row Spaced">
                          <div class="col-12">
                            <p *ngIf="action.attachments && action.attachments.length > 0">{{"ATTACHMENTS" | translate}}
                              ({{action.attachments.length}})</p>
                            <p *ngFor="let attachment of action.attachments">
                              <strong>{{attachment.name}}</strong>&nbsp;&nbsp;<a href="javascript:void(0)"
                                                                                 class="text-danger"
                                                                                 (click)="removeAttachment(action, attachment)">{{"GLOBAL.REMOVE" | translate}}</a>
                            </p>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-3 btn-block">
                        <a href="javascript:void(0)" class="btn btn-primary btn-block"
                           (click)="completeAction(action)">{{"CONFIRM" | translate}}</a>
                        <a href="javascript:void(0)" class="btn btn-block"
                           onClick="$(this).parent().parent().parent().collapse('hide')">{{"GLOBAL.CANCEL" | translate}}</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>


    <!--
             START :: UNASSIGNED
    -->
    <div class="Ribbon__section__wrap Spaced">
      <div class="Accordion--b-white Accordion__hide-links">
        <div class="row align-items-center no-gutters">
          <div class="col-sm-12">
            <h2>{{"UNASSIGNED_ACTIONS" | translate}}</h2>
            <a data-toggle="collapse" href="#collapseTwo" [attr.aria-expanded]="allUnassigned" class="Hide-all"
               [ngStyle]="{'display': allUnassigned ? 'inline' : 'none'}" (click)="showAllUnassigned(false)">{{"HIDE_ALL" | translate}}</a>
            <a data-toggle="collapse" href="#collapseTwo" [attr.aria-expanded]="allUnassigned" class="Show-all"
               [ngStyle]="{'display': !allUnassigned ? 'inline' : 'none'}" (click)="showAllUnassigned(true)">{{"SHOW_ALL" | translate}}</a>
          </div>
        </div>
      </div>
      <div class="Accordion__Content collapse show" id="collapseTwo">
        <div *ngFor="let action of prepActionService.actions">
          <!-- FILTERING IF STATEMENT -->
          <div *ngIf="!isViewing">
            <div *ngIf="(filterType == -1 || action.type == filterType) &&
                    (filterDepartment == -1 || action.department == filterDepartment) &&
                    (filterStatus == -1 || filterStatus == ActionStatus.Expired)">
              <!-- Asignee filter doesn't apply to UNASSIGNED actions: (filterAssigned == '0' || action.asignee == filterAssigned)-->
              <!-- BELONGING IN THE MODULE IF STATEMENT -->
              <div
                *ngIf="!action.isArchived && (action.asignee == '' || action.asignee == undefined || action.asignee == null) && action.isRedAlertActive(hazardRedAlert)">

                <div class="Accordion Preparedness-list">
                  <div class="Accordion Preparedness-list">
                    <div class="row Preparedness-list__item">
                      <div class="col-md-2 col-sm-2 border-right Preparedness-list__item--date">{{"DUE_ON" | translate}} <strong>{{action.dueDate
                        != null ? (action.dueDate
                        | date:"d MMM ''yy") : '-'}}</strong></div>
                      <div class="col-md-10 col-sm-10">
                        <div class="row">
                          <div class="col-md-5 col-sm-4" (click)="checkIfLink(action.task)">{{action.task}}</div>
                          <div class="col-md-2 col-sm-2 text-danger">
                          <span class="fa-stack">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-stack-1x fa-inverse fa-times"></i>
                          </span>{{ACTION_STATUS[0] | translate}}
                          </div>
                          <div class="col-md-1 col-sm-1 text-primary Preparedness-list__item--entries">

                            <a href="javascript:void(0)" class="text-primary" data-toggle="collapse"
                               [attr.data-target]="'#notes_popover_' + action.id" aria-expanded="false"
                               [attr.aria-controls]="'notes_popover_' + action.id">
                              <div class="fa-stack">
                                <i class="fa fa-comment fa-stack-2x"></i>
                                <i class="fa fa-stack-1x fa-inverse">{{action.notes.length}}</i>
                              </div>
                              <span>{{"GLOBAL.NOTES" | translate}}</span>
                            </a>
                          </div>
                          <div class="col-md-1 col-sm-1 text-primary Preparedness-list__item--entries">

                            <a href="javascript:void(0)" class="text-primary" data-toggle="collapse"
                               [attr.data-target]="'#documents_popover_' + action.id" aria-expanded="false"
                               [attr.aria-controls]="'documents_popover_' + action.id"
                               *ngIf="action.documents.length > 0">
                              <div class="fa-stack">
                                <i class="fa fa-file fa-stack-2x"></i>
                                <i class="fa fa-stack-1x fa-inverse">{{action.documents.length}}</i>
                              </div>
                              <span>{{"DOC" | translate}}</span>
                            </a>

                          </div>
                          <div class="col-md-3 col-sm-4 btn-block" *ngIf="!countrySelected
                                                && !((action.type == ActionType.mandated && !permissionsAreEnabled.mandatedAPA))
                                                && !((action.level == actionLevelEnum.MPA && !permissionsAreEnabled.customMPA.Assign) || (action.level == actionLevelEnum.APA && !permissionsAreEnabled.customAPA.Assign))">
                            <a href="javascript:void(0)" data-toggle="modal" data-target="#leadAgencySelection"
                               aria-expanded="false" aria-controls="popover_content"
                               class="btn btn-outline-primary btn-block" (click)="assignActionDialogAdv(action)">Assign
                              this action</a>

                            <a
                              *ngIf="!((action.level == actionLevelEnum.MPA && action.type == ActionType.custom && !permissionsAreEnabled.customMPA.Edit) || (action.level == actionLevelEnum.APA && action.type == ActionType.custom && !permissionsAreEnabled.customAPA.Edit))"
                              [routerLink]="['/preparedness/create-edit-preparedness', action.id]"
                              class="btn btn-block">Edit
                              action</a>
                          </div>
                          <div class="col-md-3 col-sm-4 btn-block"
                               *ngIf="isViewing && (action.type == ActionType.custom || (action.type == ActionType.mandated && !isSameAgency))">
                            <a href="javascript:void(0)" (click)="copyAction(action)"
                               class="btn btn-outline-primary btn-block ">{{"COPY_ACTION" | translate}}</a>
                          </div>
                        </div>
                        <div class="row">
                          <div class="subrow-line">{{"AGENCY_ADMIN.SETTINGS.RESPONSE_PLAN_SECTION_SETTINGS.BUDGET" | translate}}: <strong>&pound;{{action.budget}}</strong></div>
                          <div class="subrow-line">{{"TYPE" | translate}}: <strong>{{ACTION_TYPE[action.type] | translate}}</strong></div>
                          <div class="subrow-line">{{"GLOBAL.DEPARTMENT" | translate}}:
                            <strong>{{DEPARTMENT_MAP.get(action.department)}}</strong>
                          </div>
                          <div class="subrow-line">{{"ASSIGNED_TO" | translate}}: <strong>{{CURRENT_USERS.get(action.asignee) != null ?
                            CURRENT_USERS.get(action.asignee).firstName + ' ' +
                            CURRENT_USERS.get(action.asignee).lastName
                            : 'Unassigned'}}</strong></div>

                        </div>
                      </div>
                    </div>

                    <div id="notes_popover_{{action.id}}"
                         class="Popover__ribbon prevent_parent_collapse collapse col-12 notes-popover">
                      <!-- Notes -->
                      <div class="row Spaced">
                        <div class="col-md-2"></div>
                        <div class="col-md-7">
                          <div class="row">
                            <div class="col-3">
                              <h4>{{"GLOBAL.NOTES" | translate}}</h4>
                            </div>
                            <div class="col-9">
                              <p>
                                <tooltip
                                  [level1]="'TOOLTIPS.PREPAREDNESS.TT5.LEVEL1'">
                                </tooltip>
                              </p>
                            </div>
                          </div>
                          <div class="row" *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || permissionsAreEnabled.notes.New || (action.noteId != null && action.noteId != '')">
                            <div class="col-12 form-group" *ngIf="!isViewing">
                        <textarea name="confirm_complete" cols="40" rows="4" class="form-control"
                                  placeholder="{{'ADD_A_COMPLETION_NOTE_HERE' | translate}}" [(ngModel)]="action.note"></textarea>
                            </div>
                          </div>
                          <div class="row notes-popover__item Small-spaced" *ngFor="let note of action.notes">
                            <div class="col-sm-3">{{note.time | date:"d MMM yyyy"}}</div>
                            <div class="col-sm-9">
                              <div class="row">
                                <div class="col-12">
                                  {{note.content}}
                                </div>
                              </div>
                              <div class="row align-items-center">
                                <div class="col-6 text-bold Small-spaced">
                                  by {{CURRENT_USERS.get(note.uploadedBy) != null ?
                                  CURRENT_USERS.get(note.uploadedBy).firstName + ' ' +
                                  CURRENT_USERS.get(note.uploadedBy).lastName : 'Unassigned'}}
                                </div>
                                <div class="col-6 text-bold text-right"
                                     *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || note.uploadedBy == uid && note.id != action.noteId">
                                  <a *ngIf="(note.uploadedBy == uid && permissionsAreEnabled.notes.Edit)"
                                     href="javascript:void(0);" class="text-primary"
                                     (click)="editNote(note, action)">{{"EDIT" | translate}}</a>
                                  | <a *ngIf="(note.uploadedBy == uid && permissionsAreEnabled.notes.Delete)"
                                       href="javascript:void(0);" class="text-danger"
                                       (click)="deleteNote(note, action)">{{"DELETE" | translate}}</a>
                                </div>
                                <div class="col-6 text-bold text-right" *ngIf="note.id == action.noteId">
                                  {{"EDITING" | translate}}
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-3 btn-block" *ngIf="!isViewing">
                          <a *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || permissionsAreEnabled.notes.New || (action.noteId != null && action.noteId != '')"
                             href="javascript:void(0)" class="btn btn-primary btn-block"
                             (click)="addNote(action)">{{action.noteId != null && action.noteId != ''? 'SAVE NOTE' :
                            'ADD NOTE'}}</a>
                          <a href="javascript:void(0)" class="btn btn-block" (click)="disableEditNote(action)"
                             onClick="$(this).parent().parent().parent().collapse('hide')">{{"GLOBAL.CANCEL" | translate}}</a>
                          <a href="javascript:void(0)" class="btn btn-block" (click)="disableEditNote(action)"
                             *ngIf="action.noteId != null && action.noteId != ''">{{"STOP_EDITING" | translate}}</a>
                        </div>
                      </div>

                    </div>


                    <div id="documents_popover_{{action.id}}"
                         class="Popover__ribbon prevent_parent_collapse collapse col-12 documents-popover">
                      <!-- Documents -->
                      <div class="row Spaced">
                        <div class="col-md-2"></div>
                        <div class="col-md-10">
                          <div class="row Spaced align-items-center">
                            <div class="col-sm-6 col-8">
                              <h4>{{"DOCUMENTS_TEXT" | translate}} ({{action.documents.length}})</h4>&nbsp;&nbsp;<a
                              *ngIf="userType == userTypes.CountryAdmin" href="javascript:void(0);"
                              class="text-nowrap"
                              (click)="exportAllDocuments(action)">{{"DOWNLOAD_ALL" | translate}}</a>
                            </div>
                            <div class="col-sm-6 col-4 text-right">
                              <a (click)="closeDocumentsModal('documents_popover_' + action.id)"
                                 href="javascript:void(0)" class="btn btn-block">{{"GLOBAL.CLOSE" | translate}}</a>
                            </div>
                          </div>
                          <div class="row documents-popover__item">
                            <div class="col-12">
                              <p *ngFor="let doc of action.documents; let i = index" [attr.data-index]="i">
                                <strong>{{action.documents[i].fileName}}</strong>&nbsp;&nbsp;<span><a
                                *ngIf="(uid == doc.uploadedBy || userType == userTypes.CountryAdmin) || permissionsAreEnabled.other.DownloadDocuments"
                                href="javascript:void(0);" (click)="exportDocument(action, i)">{{"DOWNLOAD" | translate}}</a> |
                                <a *ngIf="uid == doc.uploadedBy || userType == userTypes.CountryAdmin"
                                   href="javascript:void(0);" class="text-danger"
                                   (click)="deleteDocument(action, doc.documentId)">{{"DELETE" | translate}}</a></span>
                              </p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="isViewing">
            <div *ngIf="(filterType == -1 || action.type == filterType) &&
                    userType != UserType.GlobalDirector && userType != UserType.RegionalDirector &&
                    !(privacy?.chs != Privacy.Public && action.type == ActionType.chs) &&
                    (filterDepartment == -1 || action.department == filterDepartment) &&
                    (filterStatus == -1 || filterStatus == ActionStatus.Expired) ||
                    (filterType == -1 || action.type == filterType) &&
                    (userType == UserType.GlobalDirector || userType == UserType.RegionalDirector || isSameAgency) &&
                    (filterDepartment == -1 || action.department == filterDepartment) &&
                    (filterStatus == -1 || filterStatus == ActionStatus.Expired)">
              <!-- Asignee filter doesn't apply to UNASSIGNED actions: (filterAssigned == '0' || action.asignee == filterAssigned)-->
              <!-- BELONGING IN THE MODULE IF STATEMENT -->
              <div
                *ngIf="!action.isArchived && (action.asignee == '' || action.asignee == undefined || action.asignee == null) && action.isRedAlertActive(hazardRedAlert)">

                <div class="Accordion Preparedness-list">
                  <div class="Accordion Preparedness-list">
                    <div class="row Preparedness-list__item">
                      <div class="col-md-2 col-sm-2 border-right Preparedness-list__item--date">{{"DUE_ON" | translate}} <strong>{{action.dueDate
                        != null ? (action.dueDate
                        | date:"d MMM ''yy") : '-'}}</strong></div>
                      <div class="col-md-10 col-sm-10">
                        <div class="row">
                          <div class="col-md-5 col-sm-4" (click)="checkIfLink(action.task)">{{action.task}}</div>
                          <div class="col-md-2 col-sm-2 text-danger">
                          <span class="fa-stack">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-stack-1x fa-inverse fa-times"></i>
                          </span>{{ACTION_STATUS[0] | translate}}
                          </div>
                          <div class="col-md-1 col-sm-1 text-primary Preparedness-list__item--entries">

                            <a href="javascript:void(0)" class="text-primary" data-toggle="collapse"
                               [attr.data-target]="'#notes_popover_' + action.id" aria-expanded="false"
                               [attr.aria-controls]="'notes_popover_' + action.id">
                              <div class="fa-stack">
                                <i class="fa fa-comment fa-stack-2x"></i>
                                <i class="fa fa-stack-1x fa-inverse">{{action.notes.length}}</i>
                              </div>
                              <span>{{"GLOBAL.NOTES" | translate}}</span>
                            </a>
                          </div>
                          <div class="col-md-1 col-sm-1 text-primary Preparedness-list__item--entries">

                            <a href="javascript:void(0)" class="text-primary" data-toggle="collapse"
                               [attr.data-target]="'#documents_popover_' + action.id" aria-expanded="false"
                               [attr.aria-controls]="'documents_popover_' + action.id"
                               *ngIf="action.documents.length > 0">
                              <div class="fa-stack">
                                <i class="fa fa-file fa-stack-2x"></i>
                                <i class="fa fa-stack-1x fa-inverse">{{action.documents.length}}</i>
                              </div>
                              <span>{{"DOC" | translate}}</span>
                            </a>

                          </div>
                          <div class="col-md-3 col-sm-4 btn-block" *ngIf="!countrySelected
                                                && !((action.type == ActionType.mandated && !permissionsAreEnabled.mandatedAPA))
                                                && !((action.level == actionLevelEnum.MPA && !permissionsAreEnabled.customMPA.Assign) || (action.level == actionLevelEnum.APA && !permissionsAreEnabled.customAPA.Assign))">
                            <a href="javascript:void(0)" data-toggle="modal" data-target="#leadAgencySelection"
                               aria-expanded="false" aria-controls="popover_content"
                               class="btn btn-outline-primary btn-block" (click)="assignActionDialogAdv(action)">{{"ASSIGN_THIS_ACTION" | translate}}</a>

                            <a
                              *ngIf="!((action.level == actionLevelEnum.MPA && action.type == ActionType.custom && !permissionsAreEnabled.customMPA.Edit) || (action.level == actionLevelEnum.APA && action.type == ActionType.custom && !permissionsAreEnabled.customAPA.Edit))"
                              [routerLink]="['/preparedness/create-edit-preparedness', action.id]"
                              class="btn btn-block">{{"EDIT_ACTION" | translate}}</a>
                          </div>
                          <div class="col-md-3 col-sm-4 btn-block"
                               *ngIf="isViewing && (action.type == ActionType.custom || (action.type == ActionType.mandated && !isSameAgency))">
                            <a href="javascript:void(0)" (click)="copyAction(action)"
                               class="btn btn-outline-primary btn-block ">{{"COPY_ACTION" | translate}}</a>
                          </div>
                        </div>
                        <div class="row">
                          <div class="subrow-line">{{"AGENCY_ADMIN.SETTINGS.RESPONSE_PLAN_SECTION_SETTINGS.BUDGET" | translate}}: <strong>&pound;{{action.budget}}</strong></div>
                          <div class="subrow-line">{{"TYPE" | translate}}: <strong>{{ACTION_TYPE[action.type] | translate}}</strong></div>
                          <div class="subrow-line">{{"GLOBAL.DEPARTMENT" | translate}}:
                            <strong>{{DEPARTMENT_MAP.get(action.department)}}</strong>
                          </div>
                          <div class="subrow-line">{{"ASSIGNED_TO" | translate}}: <strong>{{CURRENT_USERS.get(action.asignee) != null ?
                            CURRENT_USERS.get(action.asignee).firstName + ' ' +
                            CURRENT_USERS.get(action.asignee).lastName
                            : 'Unassigned'}}</strong></div>

                        </div>
                      </div>
                    </div>

                    <div id="notes_popover_{{action.id}}"
                         class="Popover__ribbon prevent_parent_collapse collapse col-12 notes-popover">
                      <!-- Notes -->
                      <div class="row Spaced">
                        <div class="col-md-2"></div>
                        <div class="col-md-7">
                          <div class="row">
                            <div class="col-3">
                              <h4>{{"GLOBAL.NOTES" | translate}}</h4>
                            </div>
                            <div class="col-9">
                              <p>
                                <tooltip
                                  [level1]="'TOOLTIPS.PREPAREDNESS.TT5.LEVEL1'">
                                </tooltip>
                              </p>
                            </div>
                          </div>
                          <div class="row" *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || permissionsAreEnabled.notes.New || (action.noteId != null && action.noteId != '')">
                            <div class="col-12 form-group" *ngIf="!isViewing">
                        <textarea name="confirm_complete" cols="40" rows="4" class="form-control"
                                  placeholder="{{'ADD_A_COMPLETION_NOTE_HERE' | translate}}" [(ngModel)]="action.note"></textarea>
                            </div>
                          </div>
                          <div class="row notes-popover__item Small-spaced" *ngFor="let note of action.notes">
                            <div class="col-sm-3">{{note.time | date:"d MMM yyyy"}}</div>
                            <div class="col-sm-9">
                              <div class="row">
                                <div class="col-12">
                                  {{note.content}}
                                </div>
                              </div>
                              <div class="row align-items-center">
                                <div class="col-6 text-bold Small-spaced">
                                  by {{CURRENT_USERS.get(note.uploadedBy) != null ?
                                  CURRENT_USERS.get(note.uploadedBy).firstName + ' ' +
                                  CURRENT_USERS.get(note.uploadedBy).lastName : 'Unassigned'}}
                                </div>
                                <div class="col-6 text-bold text-right"
                                     *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || note.uploadedBy == uid && note.id != action.noteId">
                                  <a *ngIf="(note.uploadedBy == uid && permissionsAreEnabled.notes.Edit)"
                                     href="javascript:void(0);" class="text-primary"
                                     (click)="editNote(note, action)">{{"EDIT" | translate}}</a>
                                  | <a *ngIf="(note.uploadedBy == uid && permissionsAreEnabled.notes.Delete)"
                                       href="javascript:void(0);" class="text-danger"
                                       (click)="deleteNote(note, action)">{{"DELETE" | translate}}</a>
                                </div>
                                <div class="col-6 text-bold text-right" *ngIf="note.id == action.noteId">
                                  {{"EDITING" | translate}}
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-3 btn-block" *ngIf="!isViewing">
                          <a *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || permissionsAreEnabled.notes.New || (action.noteId != null && action.noteId != '')"
                             href="javascript:void(0)" class="btn btn-primary btn-block"
                             (click)="addNote(action)">{{action.noteId != null && action.noteId != ''? 'SAVE NOTE' :
                            'ADD NOTE'}}</a>
                          <a href="javascript:void(0)" class="btn btn-block" (click)="disableEditNote(action)"
                             onClick="$(this).parent().parent().parent().collapse('hide')">{{"GLOBAL.CANCEL" | translate}}</a>
                          <a href="javascript:void(0)" class="btn btn-block" (click)="disableEditNote(action)"
                             *ngIf="action.noteId != null && action.noteId != ''">{{"STOP_EDITING" | translate}}</a>
                        </div>
                      </div>

                    </div>


                    <div id="documents_popover_{{action.id}}"
                         class="Popover__ribbon prevent_parent_collapse collapse col-12 documents-popover">
                      <!-- Documents -->
                      <div class="row Spaced">
                        <div class="col-md-2"></div>
                        <div class="col-md-10">
                          <div class="row Spaced align-items-center">
                            <div class="col-sm-6 col-8">
                              <h4>{{"DOCUMENTS_TEXT" | translate}} ({{action.documents.length}})</h4>&nbsp;&nbsp;<a
                              *ngIf="userType == userTypes.CountryAdmin" href="javascript:void(0);"
                              class="text-nowrap"
                              (click)="exportAllDocuments(action)">{{"DOWNLOAD_ALL" | translate}}</a>
                            </div>
                            <div class="col-sm-6 col-4 text-right">
                              <a (click)="closeDocumentsModal('documents_popover_' + action.id)"
                                 href="javascript:void(0)" class="btn btn-block">{{"GLOBAL.CLOSE" | translate}}</a>
                            </div>
                          </div>
                          <div class="row documents-popover__item">
                            <div class="col-12">
                              <p *ngFor="let doc of action.documents; let i = index" [attr.data-index]="i">
                                <strong>{{action.documents[i].fileName}}</strong>&nbsp;&nbsp;<span><a
                                *ngIf="(uid == doc.uploadedBy || userType == userTypes.CountryAdmin) || permissionsAreEnabled.other.DownloadDocuments"
                                href="javascript:void(0);" (click)="exportDocument(action, i)">{{"DOWNLOAD" | translate}}</a> |
                                <a *ngIf="uid == doc.uploadedBy || userType == userTypes.CountryAdmin"
                                   href="javascript:void(0);" class="text-danger"
                                   (click)="deleteDocument(action, doc.documentId)">{{"DELETE" | translate}}</a></span>
                              </p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>


    <!--
             START :: ARCHIVED
    -->
    <div class="Ribbon__section__wrap Spaced">
      <div class="Accordion--b-white Accordion__hide-links">
        <div class="row align-items-center no-gutters">
          <div class="col-sm-12">
            <h2>{{"ARCHIVED_ACTIONS" | translate}}</h2>
            <a data-toggle="collapse" href="#collapseThree" [attr.aria-expanded]="allArchived" class="Hide-all"
               [ngStyle]="{'display': allArchived ? 'inline' : 'none'}" (click)="showAllArchived(false)">{{"HIDE_ALL" | translate}}</a>
            <a data-toggle="collapse" href="#collapseThree" [attr.aria-expanded]="allArchived" class="Show-all"
               [ngStyle]="{'display': !allArchived ? 'inline' : 'none'}" (click)="showAllArchived(true)">{{"SHOW_ALL" | translate}}</a>
          </div>
        </div>
      </div>
      <div class="Accordion__Content collapse" id="collapseThree">
        <div *ngFor="let action of prepActionService.actions">
          <!-- FILTERING IF STATEMENT -->
          <div *ngIf="(filterType == -1 || action.type == filterType) &&
                    (filterDepartment == -1 || action.department == filterDepartment) &&
                    (filterAssigned == '0' || action.asignee == filterAssigned || ((action.asignee == '' || action.asignee == null) && filterAssigned == '-1')) &&
                    (filterStatus == -1 || filterStatus == ActionStatus.Archived)">
            <!-- BELONGING IN THE MODULE IF STATEMENT -->
            <div *ngIf="action.isArchived">

              <div class="Accordion Preparedness-list">
                <div class="Accordion Preparedness-list">
                  <div class="row Preparedness-list__item">
                    <div class="col-md-2 col-sm-2 border-right Preparedness-list__item--date">{{"DUE_ON" | translate}} <strong>{{action.dueDate
                      != null ? (action.dueDate
                      | date:"d MMM ''yy") : '-'}}</strong></div>
                    <div class="col-md-10 col-sm-10">
                      <div class="row">
                        <div class="col-md-5 col-sm-4" (click)="checkIfLink(action.task)">{{action.task}}</div>
                        <div class="col-md-2 col-sm-2 text-muted">
                   <span class="fa-stack">
                      <i class="fa fa-circle fa-stack-2x"></i>
                      <i class="fa fa-stack-1x fa-inverse fa-times"></i>
                   </span>
                          {{"GLOBAL.ACTION_STATUS.ARCHIVED" | translate}}
                        </div>
                        <div class="col-md-1 col-sm-1 text-primary Preparedness-list__item--entries">

                          <a href="javascript:void(0)" class="text-primary" data-toggle="collapse"
                             [attr.data-target]="'#notes_popover_' + action.id" aria-expanded="false"
                             [attr.aria-controls]="'notes_popover_' + action.id">
                            <div class="fa-stack">
                              <i class="fa fa-comment fa-stack-2x"></i>
                              <i class="fa fa-stack-1x fa-inverse">{{action.notes.length}}</i>
                            </div>
                            <span>{{"GLOBAL.NOTES" | translate}}</span>
                          </a>

                        </div>
                        <div class="col-md-1 col-sm-1 text-primary Preparedness-list__item--entries">

                          <a href="javascript:void(0)" class="text-primary" data-toggle="collapse"
                             [attr.data-target]="'#documents_popover_' + action.id" aria-expanded="false"
                             [attr.aria-controls]="'documents_popover_' + action.id"
                             *ngIf="action.documents.length > 0">
                            <div class="fa-stack">
                              <i class="fa fa-file fa-stack-2x"></i>
                              <i class="fa fa-stack-1x fa-inverse">{{action.documents.length}}</i>
                            </div>
                            <span>{{"DOC" | translate}}</span>
                          </a>

                        </div>
                        <div class="col-md-3 col-sm-4 btn-block" *ngIf="!countrySelected">
                          <a href="javascript:void(0)" data-toggle="collapse" data-target="#popover_content3"
                             aria-expanded="false" aria-controls="popover_content" (click)="reactivate(action)"
                             class="btn btn-outline-primary btn-block text-muted btn-outline-secondary">{{"GLOBAL.RE_ACTIVATE" | translate}}</a>

                          <a
                            *ngIf="!((action.level == actionLevelEnum.MPA && action.type == ActionType.custom && !permissionsAreEnabled.customMPA.Edit) || (action.level == actionLevelEnum.APA && action.type == ActionType.custom && !permissionsAreEnabled.customAPA.Edit))"
                            [routerLink]="['/preparedness/create-edit-preparedness', action.id]"
                            class="btn btn-block">Edit
                            action</a>
                        </div>
                        <div class="col-md-3 col-sm-4 btn-block"
                             *ngIf="isViewing && (action.type == ActionType.custom || (action.type == ActionType.mandated && !isSameAgency))">
                          <a href="javascript:void(0)" (click)="copyAction(action)"
                             class="btn btn-outline-primary btn-block ">{{"COPY_ACTION" | translate}}</a>
                        </div>
                      </div>
                      <div class="row">
                        <div class="subrow-line">{{"AGENCY_ADMIN.SETTINGS.RESPONSE_PLAN_SECTION_SETTINGS.BUDGET" | translate}}: <strong>&pound;{{action.budget}}</strong></div>
                        <div class="subrow-line">{{"TYPE" | translate}}: <strong>{{ACTION_TYPE[action.type] | translate}}</strong>
                        </div>
                        <div class="subrow-line">{{"GLOBAL.DEPARTMENT" | translate}}: <strong>{{DEPARTMENT_MAP.get(action.department)}}</strong>
                        </div>
                        <div class="subrow-line">{{"ASSIGNED_TO" | translate}}: <strong>{{CURRENT_USERS.get(action.asignee) != null ?
                          CURRENT_USERS.get(action.asignee).firstName + ' ' + CURRENT_USERS.get(action.asignee).lastName
                          : 'Unassigned'}}</strong></div>

                      </div>
                    </div>

                    <div id="notes_popover_{{action.id}}"
                         class="Popover__ribbon prevent_parent_collapse collapse col-12 notes-popover">
                      <!-- Notes -->
                      <div class="row Spaced">
                        <div class="col-md-2"></div>
                        <div class="col-md-7">
                          <div class="row">
                            <div class="col-3">
                              <h4>{{"GLOBAL.NOTES" | translate}}</h4>
                            </div>
                            <div class="col-9">
                              <p>
                                <tooltip
                                  [level1]="'TOOLTIPS.PREPAREDNESS.TT5.LEVEL1'">
                                </tooltip>
                              </p>
                            </div>
                          </div>
                          <div class="row" *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || permissionsAreEnabled.notes.New || (action.noteId != null && action.noteId != '')">
                            <div class="col-12 form-group" *ngIf="!isViewing">
                        <textarea name="confirm_complete" cols="40" rows="4" class="form-control"
                                  placeholder="Add a completion note here" [(ngModel)]="action.note"></textarea>
                            </div>
                          </div>
                          <div class="row notes-popover__item Small-spaced" *ngFor="let note of action.notes">
                            <div class="col-sm-3">{{note.time | date:"d MMM yyyy"}}</div>
                            <div class="col-sm-9">
                              <div class="row">
                                <div class="col-12">
                                  {{note.content}}
                                </div>
                              </div>
                              <div class="row align-items-center">
                                <div class="col-6 text-bold Small-spaced">
                                  {{"BY" | translate}} {{CURRENT_USERS.get(note.uploadedBy) != null ?
                                  CURRENT_USERS.get(note.uploadedBy).firstName + ' ' +
                                  CURRENT_USERS.get(note.uploadedBy).lastName : 'Unassigned'}}
                                </div>
                                <div class="col-6 text-bold text-right"
                                     *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || note.uploadedBy == uid && note.id != action.noteId">
                                  <a *ngIf="(note.uploadedBy == uid && permissionsAreEnabled.notes.Edit)"
                                     href="javascript:void(0);" class="text-primary"
                                     (click)="editNote(note, action)">{{"EDIT" | translate}}</a>
                                  | <a *ngIf="(note.uploadedBy == uid && permissionsAreEnabled.notes.Delete)"
                                       href="javascript:void(0);" class="text-danger"
                                       (click)="deleteNote(note, action)">{{"DELETE" | translate}}</a>
                                </div>
                                <div class="col-6 text-bold text-right" *ngIf="note.id == action.noteId">
                                  {{"EDITING" | translate}}
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-3 btn-block" *ngIf="!isViewing">
                          <a *ngIf="userType == userTypes.CountryDirector || userType == userTypes.RegionalDirector || userType == userTypes.CountryAdmin
                                                || permissionsAreEnabled.notes.New || (action.noteId != null && action.noteId != '')"
                             href="javascript:void(0)" class="btn btn-primary btn-block"
                             (click)="addNote(action)">{{action.noteId != null && action.noteId != ''? 'SAVE NOTE' :
                            'ADD NOTE'}}</a>
                          <a href="javascript:void(0)" class="btn btn-block" (click)="disableEditNote(action)"
                             onClick="$(this).parent().parent().parent().collapse('hide')">{{"GLOBAL.CANCEL" | translate}}</a>
                          <a href="javascript:void(0)" class="btn btn-block" (click)="disableEditNote(action)"
                             *ngIf="action.noteId != null && action.noteId != ''">{{"STOP_EDITING" | translate}}</a>
                        </div>
                      </div>

                    </div>


                    <div id="documents_popover_{{action.id}}"
                         class="Popover__ribbon prevent_parent_collapse collapse col-12 documents-popover">
                      <!-- Documents -->
                      <div class="row Spaced">
                        <div class="col-md-2"></div>
                        <div class="col-md-10">
                          <div class="row Spaced align-items-center">
                            <div class="col-sm-6 col-8">
                              <h4>{{"DOCUMENTS_TEXT" | translate}} ({{action.documents.length}})</h4>&nbsp;&nbsp;<a
                              *ngIf="userType == userTypes.CountryAdmin" href="javascript:void(0);"
                              class="text-nowrap"
                              (click)="exportAllDocuments(action)">{{"DOWNLOAD_ALL" | translate}}</a>
                            </div>
                            <div class="col-sm-6 col-4 text-right">
                              <a (click)="closeDocumentsModal('documents_popover_' + action.id)"
                                 href="javascript:void(0)" class="btn btn-block">{{"GLOBAL.CLOSE" | translate}}</a>
                            </div>
                          </div>
                          <div class="row documents-popover__item">
                            <div class="col-12">
                              <p *ngFor="let doc of action.documents; let i = index" [attr.data-index]="i">
                                <strong>{{action.documents[i].fileName}}</strong>&nbsp;&nbsp;<span><a
                                *ngIf="(uid == doc.uploadedBy || userType == userTypes.CountryAdmin) || permissionsAreEnabled.other.DownloadDocuments"
                                href="javascript:void(0);" (click)="exportDocument(action, i)">{{"DOWNLOAD" | translate}}</a> |
                                <a *ngIf="uid == doc.uploadedBy || userType == userTypes.CountryAdmin"
                                   href="javascript:void(0);" class="text-danger"
                                   (click)="deleteDocument(action, doc.documentId)">{{"DELETE" | translate}}</a></span>
                              </p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- end #wrap -->
</div>

<!--Lead Agency Selection Modal (first time agency is invited)-->
<div class="modal fade" id="leadAgencySelection" tabindex="-1" role="dialog"
     aria-labelledby="leadAgencySelection"
     aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" class="Spaced-above">{{"ASSIGN_THIS_ACTION" | translate}}</h6>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p class="col-sm-12"><strong>{{"ASSIGN_TO" | translate}}</strong></p>
        <div class="col-sm-12">
          <select name="" id="" class="form-control" [(ngModel)]="assignActionAsignee"
                  *ngIf="userType == UserType.CountryDirector || userType == UserType.CountryAdmin || userType == UserType.ErtLeader">
            <option value="0" disabled selected hidden>{{'GLOBAL.PLEASE_SELECT'| translate}}</option>
            <option *ngFor="let x of ASSIGNED_TOO; let i = index" [attr.data-index]="i" value="{{x.id}}">{{x.firstName +
              ' ' + x.lastName}}
            </option>
          </select>
          <select name="" id="" class="form-control" [(ngModel)]="assignActionAsignee" *ngIf="userType == UserType.Ert">
            <option value="{{uid}}">{{myFirstName + ' ' + myLastName}}</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <div class="row Right-aligned Spaced col-sm-12">
          <a class="col-sm-9 margin-top-one"
             (click)="closeModal()">{{"GLOBAL.CANCEL" | translate}}</a>
          <button
            class="btn btn-primary col-sm-3 text-uppercase" (click)="saveAssignedUser()">{{"SAVE" | translate}}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
